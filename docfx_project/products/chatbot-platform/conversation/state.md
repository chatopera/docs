## 对话状态管理

在多轮对话中，来访者和机器人对话的过程可以想像成来访者使用地图游览，每个时刻，来访者的位置都可以映射到地图上。地图有一定的行走路径，来访者下一步所能选择的方向是由当前状态提供的。

现在，来访者与机器人对话的状态会保持 30 分钟，比如来访者想要点餐，但是说了一句“我要点晚餐”，然后半个小时没有继续发送信息，那么等来访者再次发送信息时，机器人已经不记得上文了。

上下文状态和机器人记忆，都是让机器人有更强的对话处理能力：通过**上下轮钩子**和**通配符取值**，设计对话流程，满足各种定制化业务。

在实际应用中，对话状态按照匹配器、上下轮钩子和时间作用改变外，还有哪些办法影响对话状态呢？以下介绍三种方法，改变对话状态。

## 清除状态

所谓清除状态，就是在处理完某次回复，不再需要用户处于当前对话状态，而恢复默认对话状态。

解决办法：设置回复的文本以 `{CLEAR}` 开头。比如：

```
+ 再见
- {CLEAR} 感谢您选择我们，期待再次光临！
```

`{CLEAR}` 可以添加在 **回复** 或 **函数返回值**中。在 Chatopera 机器人平台返回给来访者时，文本内容会去掉这个前缀。

这个方法很实用，尤其是在**全能匹配器**，对话可能进入死循环，因为所有的输入都被全能匹配拦截，那么在对应的回复中使用`{CLEAR}`就达到了下一次对话进入默认状态，不优先匹配**全能匹配器**的目的。

## 切换话题

在多轮对话中，开发者可以定义多个**对话主题**，对话主题的名字是字母组成的字符串，使用回复在不同对话主题间跳转。

```
+ 你好
- ^topicRedirect("greetings","你好")
```

_topicRedirect_ 是内置的函数，第一个参数是目标主题名字，第二个参数是目标匹配器。

## 知识库路由

设置知识库问答对，在答案中按照特定格式书写，直接路由到多轮对话的主题和匹配器。

在 Chatopera 机器人平台中，多轮对话检索过程中，使用[洋葱模型](https://www.infoq.cn/article/2014/11/ddd-onion-architecture)。[多轮对话检索接口](/products/chatbot-platform/integration/api.html#检索多轮对话)时，会先检索知识库，参考知识库的检索结果执行回复逻辑。此处进一步参考：

[多轮对话检索逻辑](/products/chatbot-platform/integration/api.html#服务器端逻辑)

## 评论

<script src="https://utteranc.es/client.js"
        repo="chatopera/docs"
        issue-term="pathname"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
